<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","version":"8.3.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="redis基本常识">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="http://example.com/2021/08/01/Redis/index.html">
<meta property="og:site_name" content="Virgoniagee&#39;s blog">
<meta property="og:description" content="redis基本常识">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-07-31T17:33:34.000Z">
<meta property="article:modified_time" content="2021-08-03T06:56:14.797Z">
<meta property="article:author" content="Virogoniagee">
<meta property="article:tag" content="连接">
<meta property="article:tag" content="数据类型">
<meta property="article:tag" content="事务">
<meta property="article:tag" content="持久化">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2021/08/01/Redis/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>Redis | Virgoniagee's blog</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Virgoniagee's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Redis"><span class="nav-number">1.</span> <span class="nav-text">Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.1.</span> <span class="nav-text">连接</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0"><span class="nav-number">1.1.1.</span> <span class="nav-text">本地</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9C%E7%A8%8B"><span class="nav-number">1.1.2.</span> <span class="nav-text">远程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.2.</span> <span class="nav-text">数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2String"><span class="nav-number">1.2.1.</span> <span class="nav-text">字符串String</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%93%8D"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">基操</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%A2%9E%E8%87%AA%E5%87%8F"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">自增自减</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A9%E5%AE%B9"><span class="nav-number">1.2.1.3.</span> <span class="nav-text">扩容</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%97%E8%A1%A8List"><span class="nav-number">1.2.2.</span> <span class="nav-text">列表List</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%93%8D-1"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">基操</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">数据结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E5%90%88Set"><span class="nav-number">1.2.3.</span> <span class="nav-text">集合Set</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%93%8D-2"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">基操</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-1"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">数据结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%88%E5%B8%8CHash"><span class="nav-number">1.2.4.</span> <span class="nav-text">哈希Hash</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%93%8D-3"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">基操</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-2"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">数据结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zset"><span class="nav-number">1.2.5.</span> <span class="nav-text">Zset</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%93%8D-4"><span class="nav-number">1.2.5.1.</span> <span class="nav-text">基操</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-3"><span class="nav-number">1.2.5.2.</span> <span class="nav-text">数据结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bitmaps"><span class="nav-number">1.2.6.</span> <span class="nav-text">Bitmaps</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%93%8D-5"><span class="nav-number">1.2.6.1.</span> <span class="nav-text">基操</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.2.6.2.</span> <span class="nav-text">实践</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#vs-Set"><span class="nav-number">1.2.6.3.</span> <span class="nav-text">vs Set</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HyperLogLog"><span class="nav-number">1.2.7.</span> <span class="nav-text">HyperLogLog</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%93%8D-6"><span class="nav-number">1.2.7.1.</span> <span class="nav-text">基操</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%94%E7%94%A8"><span class="nav-number">1.2.7.2.</span> <span class="nav-text">应用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Geospatial"><span class="nav-number">1.2.8.</span> <span class="nav-text">Geospatial</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%93%8D-7"><span class="nav-number">1.2.8.1.</span> <span class="nav-text">基操</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%94%E7%94%A8-1"><span class="nav-number">1.2.8.2.</span> <span class="nav-text">应用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1"><span class="nav-number">1.3.</span> <span class="nav-text">事务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%93%8D-8"><span class="nav-number">1.3.1.</span> <span class="nav-text">基操</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%99%E8%AF%AF"><span class="nav-number">1.3.2.</span> <span class="nav-text">错误</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%84%E9%98%9F%E4%B8%AD"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">组队中</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E4%B8%AD"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">运行中</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%81"><span class="nav-number">1.3.3.</span> <span class="nav-text">锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%82%B2%E8%A7%82%E9%94%81"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">悲观锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B9%90%E8%A7%82%E9%94%81"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">乐观锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%93%8D-9"><span class="nav-number">1.3.3.3.</span> <span class="nav-text">基操</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E6%80%A7"><span class="nav-number">1.3.4.</span> <span class="nav-text">特性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">1.4.</span> <span class="nav-text">持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RDB"><span class="nav-number">1.4.1.</span> <span class="nav-text">RDB</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%87%E7%A8%8B"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%87%E4%BB%BD"><span class="nav-number">1.4.1.4.</span> <span class="nav-text">备份</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%89%B9%E7%82%B9"><span class="nav-number">1.4.1.5.</span> <span class="nav-text">特点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AOF"><span class="nav-number">1.4.2.</span> <span class="nav-text">AOF</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%87%E7%A8%8B-1"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%86%E8%8A%82"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">细节</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Rewrite%E5%8E%8B%E7%BC%A9"><span class="nav-number">1.4.2.3.</span> <span class="nav-text">Rewrite压缩</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%89%B9%E7%82%B9-1"><span class="nav-number">1.4.2.4.</span> <span class="nav-text">特点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RDB%E5%92%8CAOF"><span class="nav-number">1.4.3.</span> <span class="nav-text">RDB和AOF</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">1.5.</span> <span class="nav-text">主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.5.1.</span> <span class="nav-text">实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4"><span class="nav-number">1.6.</span> <span class="nav-text">集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-1"><span class="nav-number">1.6.1.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D"><span class="nav-number">1.6.2.</span> <span class="nav-text">故障恢复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%BF%E7%82%B9%E7%82%B9%E7%BB%86%E8%8A%82"><span class="nav-number">1.6.3.</span> <span class="nav-text">亿点点细节</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%B8%B8%E8%A7%81BUG"><span class="nav-number">1.7.</span> <span class="nav-text">应用常见BUG</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="nav-number">1.7.1.</span> <span class="nav-text">缓存穿透</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF"><span class="nav-number">1.7.1.1.</span> <span class="nav-text">场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E5%9B%A0"><span class="nav-number">1.7.1.2.</span> <span class="nav-text">原因</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3"><span class="nav-number">1.7.1.3.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="nav-number">1.7.2.</span> <span class="nav-text">缓存击穿</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF-1"><span class="nav-number">1.7.2.1.</span> <span class="nav-text">场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E5%9B%A0-1"><span class="nav-number">1.7.2.2.</span> <span class="nav-text">原因</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-1"><span class="nav-number">1.7.2.3.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="nav-number">1.7.3.</span> <span class="nav-text">缓存雪崩</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF-2"><span class="nav-number">1.7.3.1.</span> <span class="nav-text">场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E5%9B%A0-2"><span class="nav-number">1.7.3.2.</span> <span class="nav-text">原因</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-2"><span class="nav-number">1.7.3.3.</span> <span class="nav-text">解决</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="nav-number">1.7.4.</span> <span class="nav-text">分布式锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#redis%E5%88%86%E5%B8%83%E9%94%81"><span class="nav-number">1.7.4.1.</span> <span class="nav-text">redis分布锁</span></a></li></ol></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Virogoniagee"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Virogoniagee</p>
  <div class="site-description" itemprop="description">be 😎. be 🐱</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Virgoniagee" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Virgoniagee" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:sherleypeetzo@gmail.com" title="E-Mail → mailto:sherleypeetzo@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/01/Redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Virogoniagee">
      <meta itemprop="description" content="be 😎. be 🐱">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Virgoniagee's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-01 01:33:34" itemprop="dateCreated datePublished" datetime="2021-08-01T01:33:34+08:00">2021-08-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-03 14:56:14" itemprop="dateModified" datetime="2021-08-03T14:56:14+08:00">2021-08-03</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">redis基本常识</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><p>Redis是非关系型数据库，用[k,v]键值对来存储数据，默认的Redis初始的数据库有16个，在进入redis-cli后通过<code>&gt; select [index]</code>选择要操作的数据库</p>
<p>作为非关系型数据库，在实际的开发中，常常作为数据库缓存来使用，比如存储session，保证用户在跳转不同服务器微服务时是同一个用户认证；存储数据字典。</p>
<h2 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h2><h3 id="本地"><a href="#本地" class="headerlink" title="本地"></a>本地</h3><p>在本地下载redis，常常装在服务器中，学习时用虚拟机安装</p>
<p>直接启动得到redis图标是前台启动，关闭窗口则连接中断</p>
<p>使用<code>redis-server ../*.conf</code> 启动是后台启动，关闭窗口仍可连接</p>
<p>再使用<code>redis-cli -h ip -p port -a password </code>连接操作redis</p>
<p>redis.conf中注释掉bind 127.0.0.1 ,然后 protected-mode no</p>
<p>防火墙关闭</p>
<p>重启服务</p>
<h3 id="远程"><a href="#远程" class="headerlink" title="远程"></a>远程</h3><p>比如服务器是阿里云，服务器上安装好redis，修改conf文件中的bind 127.0.0.1注释或修改为0.0.0.0，表示所有的ip客户端都可以访问。</p>
<p>云服务器不能关闭防火墙，否则会受到攻击，危险较高，所以需要在安全组内添加redis的安全组，开放redis的访问端口，同时设置redis的登录密码。</p>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><h3 id="字符串String"><a href="#字符串String" class="headerlink" title="字符串String"></a>字符串String</h3><p>String类型是二进制安全的。意味着Redis的string可以包含任何数据。比如jpg图片或者序列化的对象。</p>
<p>String类型是Redis最基本的数据类型，一个Redis中字符串value最多可以是512M。</p>
<h4 id="基操"><a href="#基操" class="headerlink" title="基操"></a>基操</h4><pre><code>get   &lt;key&gt;查询对应键值
append  &lt;key&gt;&lt;value&gt;将给定的&lt;value&gt; 追加到原值的末尾
strlen  &lt;key&gt;获得值的长度
setnx  &lt;key&gt;&lt;value&gt;只有在 key 不存在时设置 key 的值
</code></pre>
<h4 id="自增自减"><a href="#自增自减" class="headerlink" title="自增自减"></a>自增自减</h4><pre><code>incr  &lt;key&gt;
decr  &lt;key&gt;
</code></pre>
<p>说明：redis没有ACID的特性，即没有原子性，所以线程在操作时，随时可能改变到别的线程正在操作的数据，所以redis是单线程操作，可以视为是原子性操作。</p>
<h4 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h4><p>总长&lt;1M 加倍</p>
<p>总成&gt;1M 每次+1M</p>
<h3 id="列表List"><a href="#列表List" class="headerlink" title="列表List"></a>列表List</h3><p>是简单的字符串列表，按照插入顺序排序，可以选择头插或尾插</p>
<h4 id="基操-1"><a href="#基操-1" class="headerlink" title="基操"></a>基操</h4><pre><code>lpush/rpush &lt;key&gt; &lt;value1&gt; &lt;&gt; ...从左边/右边插入一个或多个值
lpop/rpop &lt;key&gt; 从左边/右边吐出一个值 值在键在，值光键亡

rpoplpush &lt;key1&gt; &lt;key2&gt; 从&lt;key1&gt;列表右边吐出一个值
                                插到&lt;key2&gt;列表左边
lrange &lt;key&gt; &lt;start&gt; &lt;stop&gt; 按照索引下标获得元素
lrange mylist 0 -1 获得所有元素
lindex &lt;key&gt; &lt;index&gt; 按照索引下标获得元素(从左到右)
llen &lt;key&gt; 获得列表长度 

linsert &lt;key&gt; before/after &lt;value&gt;&lt;newvalue&gt;
            在&lt;value&gt;的前/后插入&lt;newvalue&gt;
lrem &lt;key&gt; &lt;n&gt; &lt;value&gt; 从左边删除n个value(从左到右)
lset &lt;key&gt; &lt;index&gt; &lt;value&gt; 将列表key下标为index的值替换成value
</code></pre>
<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><p>List底层的数据结构为双向链表，对端操作友好，但索引较差。</p>
<p>更准确的说，是快速链表quickList。</p>
<ul>
<li>列表元素少时，用连续的内存用zipList，压缩列表，是连续的内存</li>
<li>列表元素多时，改为quickList</li>
</ul>
<h3 id="集合Set"><a href="#集合Set" class="headerlink" title="集合Set"></a>集合Set</h3><p>区别List是自动排重，无序集合，使用hash表，可以快速定位，增删查O(1)</p>
<h4 id="基操-2"><a href="#基操-2" class="headerlink" title="基操"></a>基操</h4><pre><code>sadd &lt;key&gt; &lt;value1&gt; &lt;value2&gt; ...
    将一个或多个 member 元素加入到集合 key 中并去重
smembers &lt;key&gt; 取出该集合的所有值。
sismember &lt;key&gt; &lt;value&gt; key中包含value？
scard &lt;key&gt; 返回该集合的元素个数。
srem &lt;key&gt; &lt;value1&gt; ... 删除集合中的某个元素
spop &lt;key&gt; 随机从该集合中吐出一个值
srandmember &lt;key&gt; &lt;n&gt; 随机从该集合中获得n个值

##多集合操作
smove &lt;source&gt; &lt;destination&gt; &lt;value&gt; 目标移动集合
sinter &lt;key1&gt; &lt;key2&gt; 交集元素
sunion &lt;key1&gt; &lt;key2&gt; 并集元素
sdiff &lt;key1&gt; &lt;key2&gt; 差集元素(key1中，不包含key2)
</code></pre>
<h4 id="数据结构-1"><a href="#数据结构-1" class="headerlink" title="数据结构"></a>数据结构</h4><p>Set数据结构是dict字典，字典是用哈希表实现的，所有的value指向同一个内部值。</p>
<h3 id="哈希Hash"><a href="#哈希Hash" class="headerlink" title="哈希Hash"></a>哈希Hash</h3><p>键值对集合，是一个string类型的field和value的映射表，hash特别适合用于存储对象。</p>
<p>存储的方式为<code>&lt;key,&lt;field,value&gt;&gt;</code></p>
<p>优化了redis作为非关系型数据库对对象的存储。</p>
<h4 id="基操-3"><a href="#基操-3" class="headerlink" title="基操"></a>基操</h4><pre><code>hset &lt;key&gt; &lt;field&gt; &lt;value&gt; 创建hash
hget &lt;key&gt; &lt;field&gt; 取key下对应field的value 
hmset &lt;key1&gt; &lt;field1&gt; &lt;value1&gt; &lt;field2&gt; &lt;value2&gt; 批量添加
hexists &lt;key1&gt; &lt;field&gt; 有属性吗
hkeys &lt;key&gt; 列fileds
hvals &lt;key&gt; 列values
hincrby &lt;key&gt; &lt;field&gt; &lt;increment&gt; filed自增
hsetnx &lt;key&gt; &lt;field&gt; &lt;value&gt; 新建一个field并赋值
</code></pre>
<h4 id="数据结构-2"><a href="#数据结构-2" class="headerlink" title="数据结构"></a>数据结构</h4><p>Hash类型对应的数据结构是两种</p>
<ul>
<li>ziplist（压缩列表）–field-value长度较短且个数较少时</li>
<li>hashtable（哈希表）–否则</li>
</ul>
<h3 id="Zset"><a href="#Zset" class="headerlink" title="Zset"></a>Zset</h3><p>Zset和set的底层存储都是redis特别的zipList和slipList，不同的是，Zset存储的方式为<code>&lt;key,&lt;score,value&gt;&gt;</code>，通过score为值排序，实现有序存储，value不可重复，而score可以相同。</p>
<h4 id="基操-4"><a href="#基操-4" class="headerlink" title="基操"></a>基操</h4><pre><code>zadd &lt;key&gt; &lt;score1&gt; &lt;value1&gt; &lt;score2&gt; &lt;value2&gt;...
zrange &lt;key&gt; &lt;start&gt; &lt;stop&gt;  [WITHSCORES]   
返回有序集key中，下标在&lt;start&gt;&lt;stop&gt;之间的元素
带WITHSCORES，可以让分数一起和值返回到结果集
zrangebyscore key min max [withscores] [limit offset count]
返回有序集key中，所有score值在[min,max]之间的增序
可将zrangebyscore改为zrevrangebysocre表示降序
zincrby &lt;key&gt; &lt;increment&gt; &lt;value&gt; 为元素的score加上增量
zrem &lt;key&gt; &lt;value&gt; 删除该集合下指定值的元素 
zcount &lt;key&gt; &lt;min&gt; &lt;max&gt; 统计该集合分数区间内的元素个数 
zrank &lt;key&gt; &lt;value&gt; 返回该值在集合中的排名，从0开始
</code></pre>
<h4 id="数据结构-3"><a href="#数据结构-3" class="headerlink" title="数据结构"></a>数据结构</h4><p>slipList的存储方式比较向B+树，添加节点时自底向上，查找节点时自顶向下，由于不需要遍历所有的节点，而通过3层结构中节点值的比较来判断score的范围，所以效率要比普通的顺序存储要高的多</p>
<h3 id="Bitmaps"><a href="#Bitmaps" class="headerlink" title="Bitmaps"></a>Bitmaps</h3><p>以字节为单位，位为信息位存储，本质是字符串，但是操作位是bit，简称操作到位、统计到节</p>
<p>以字符串的偏移量及index作为id映射，用1/0占位标识有无</p>
<h4 id="基操-5"><a href="#基操-5" class="headerlink" title="基操"></a>基操</h4><pre><code>setbit &lt;key&gt; &lt;offset&gt; &lt;value&gt; 设置offset的值
getbit &lt;key&gt; &lt;offset&gt; 获得offset的值
bitcount &lt;key&gt; [start end] 统计start-end的总数
</code></pre>
<p>start 和 end 不是以bit作为单位，以字节为单位</p>
<pre><code>bitop and(or/not/xor) &lt;destkey&gt; [key…] op得到destkey
</code></pre>
<h4 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h4><p>常作为网站用户量的统计，用bit位统计用户是否访问，并统计数量</p>
<p>统计用户日/周/月/季/年活跃度</p>
<h4 id="vs-Set"><a href="#vs-Set" class="headerlink" title="vs Set"></a>vs Set</h4><p>高活跃群体统计时，用Bitmaps最优</p>
<p>而统计较低访问量的网站活跃度，则用Set最优</p>
<p>因为用Set记录的是某个时间段内访问的人，Bitmaps是以全站所有用户为范围统计</p>
<h3 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h3><p>求集合中不重复元素个数的问题称为基数问题，降低了一定精度平衡存储空间，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的。</p>
<h4 id="基操-6"><a href="#基操-6" class="headerlink" title="基操"></a>基操</h4><pre><code>pfadd &lt;key&gt; &lt;element&gt; [element ...]   添加指定元素
pfcount &lt;key&gt; [key ...] 计算HLL的近似基数
pfmerge &lt;destkey&gt; &lt;sourcekey&gt; ... 合并
</code></pre>
<h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><p>以较小的存储代价计算非重复用户的数量，即在匿名用户访问时，统计访问量以其ip作为依据，而不是连接次数</p>
<h3 id="Geospatial"><a href="#Geospatial" class="headerlink" title="Geospatial"></a>Geospatial</h3><p>提供了经纬度设置，查询，范围查询，距离查询，经纬度Hash等常见操作</p>
<h4 id="基操-7"><a href="#基操-7" class="headerlink" title="基操"></a>基操</h4><pre><code>geoadd &lt;key&gt; &lt;经度&gt; &lt;纬度&gt; &lt;m&gt; ...  添加地理位置
geopos &lt;key&gt; &lt;m&gt; [m...]  获得指定地区的坐标值
geodist &lt;key&gt; &lt;m1&gt; &lt;m2&gt; [m|km|ft|mi] 两地间直线距离
georadius &lt;key&gt; &lt;longitude&gt; &lt;latitude&gt; radius  m|km|ft|mi 
</code></pre>
<h4 id="应用-1"><a href="#应用-1" class="headerlink" title="应用"></a>应用</h4><p>附近的人等距离统计，非常的方便。</p>
<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>Redis事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。</p>
<p>Redis事务的主要作用就是串联多个命令防止别的命令插队。</p>
<p>前面提到过，redis没有mysql中事务ACID的特性，并且redis是单线程操作。</p>
<h3 id="基操-8"><a href="#基操-8" class="headerlink" title="基操"></a>基操</h3><ul>
<li>multi 表示一下开始事务的排队</li>
<li>exec 结束排队并执行队伍中的操作</li>
<li>discard 放弃组队，在multi后执行，pop队列中的操作</li>
</ul>
<h3 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h3><h4 id="组队中"><a href="#组队中" class="headerlink" title="组队中"></a>组队中</h4><p>在执行multi后，若某一个命令输错了，整个队列取消</p>
<h4 id="运行中"><a href="#运行中" class="headerlink" title="运行中"></a>运行中</h4><p>在执行exec后，若是某一个命令执行中断出错了，其他命令照样执行，并不胡回滚</p>
<h3 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h3><h4 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h4><p>类似于Java中的synchronized，让事务进入单线程状态，静止访问。</p>
<p>传统的关系型数据库里边就用到了很多这种锁机制，比如行锁，表锁等，读锁，写锁等，都是在做操作之前先上锁。</p>
<p>名为悲观：提前设想悲观情形，事务会被多线程访问，所以先上锁</p>
<h4 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h4><p>check-and-set 先检查再设置，MP中的@Version是一样的道理，set前先检查访问时的版本和set时的版本号是不是相同的，若是相同的才set。</p>
<p>乐观锁适用于多读的应用类型，这样可以提高吞吐量。Redis就是利用这种check-and-set机制实现事务的。</p>
<h4 id="基操-9"><a href="#基操-9" class="headerlink" title="基操"></a>基操</h4><pre><code>WATCH key [key ...]
</code></pre>
<p>需要在所有的cli中都监视，才能做到事务乐观锁</p>
<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ol>
<li>单独的隔离操作 </li>
</ol>
<ul>
<li>事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。 </li>
</ul>
<ol start="2">
<li>没有隔离级别的概念 </li>
</ol>
<ul>
<li>队列中的命令没有提交之前都不会实际被执行，因为事务提交前任何指令都不会被实际执行</li>
</ul>
<ol start="3">
<li>不保证原子性 </li>
</ol>
<ul>
<li>事务中如果有一条命令执行失败，其后的命令仍然会被执行，没有回滚 </li>
</ul>
<h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><p>通俗讲，持久化操作就是为了让数据更长时间的保存。Redis提供了两种持久化操作，RDB和AOF。</p>
<h3 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h3><p>在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是行话讲的Snapshot快照，它恢复时是将快照文件直接读到内存里。</p>
<h4 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h4><blockquote>
<p>差个图片 等域名备案和七牛云绑定</p>
</blockquote>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>在redis.conf文件中找到<code>dbfilename xxx.rdb</code>，就表示子程序快照的备份数据都放到该文件中。</p>
<p>rdb文件的保存路径，也可以修改，<code>dir &quot;/myredis/&quot;</code>。默认为Redis启动时命令行所在的目录下，<code>dir ./</code>。</p>
<p>配置快照触发的条件 save s t 表示在s秒后如果有t个key被修改了那就快照一下。</p>
<pre><code>###SNAPSHOTTING快照###
save 如上解释
stop-writes-on-bgsave-error 字面意思 一般yes
rdbcompression yes 表示快照用LZF算法压缩
rdbchecksum yes 表示redis用CRC64算法来进行数据校验 不利性能
</code></pre>
<h4 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h4><ul>
<li>save ：save时只管保存，其它不管，全部阻塞。手动保存。</li>
<li>bgsave：Redis会在后台异步进行快照操作，快照同时还可以响应客户端请求。</li>
<li>可以通过lastsave 命令获取最后一次成功执行快照的时间</li>
</ul>
<h4 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h4><p>若是原本的快照文件被删除，同时本身谨慎的有快照文件的备份，那cp把备份文件放到rdb工作目录下，重启redis后会自动恢复数据</p>
<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul>
<li>优势</li>
</ul>
<ol>
<li>适合大规模的数据恢复</li>
<li>对数据完整性和一致性要求不高更适合使用</li>
<li>节省磁盘空间</li>
<li>恢复速度快</li>
</ol>
<ul>
<li>劣势</li>
</ul>
<ol>
<li>fork就要克隆，大致2倍的膨胀性</li>
<li>在fork时使用了写时拷贝技术,但是如果数据庞大时还是比较消耗性能</li>
<li>快照有间隔，间隔内down掉redis则最新数据丢失</li>
</ol>
<h3 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h3><p>以日志的形式来记录每个写操作，AOF全名是Append Only File，看出来是个增量操作，只能增加不能修改。</p>
<h4 id="过程-1"><a href="#过程-1" class="headerlink" title="过程"></a>过程</h4><ol>
<li>客户端请求写操作被放到AOF缓存区</li>
<li>AOF根据持久化策略持久化到磁盘中，主要是执行持久化的频率</li>
<li>AOF文件大小超过重写策略或手动重写时，会对AOF文件rewrite重写，压缩AOF文件容量</li>
<li>redis重启加载AOF磁盘中的文件，达到回复的目的</li>
</ol>
<h4 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h4><p>AOF默认不开启，需要开启的话到.conf文件中配置.aof文件，该文件和.rdb文件一样放在启动目录下。</p>
<p>因为AOF默认不开启，所以当AOF和RDB同时存在的时候，默认恢复的是AOF文件，此时RDB文件任然是存在的。</p>
<p>毁坏恢复的过程和RDB一样</p>
<h4 id="Rewrite压缩"><a href="#Rewrite压缩" class="headerlink" title="Rewrite压缩"></a>Rewrite压缩</h4><p>因为AOF是增量操作，那么文件就会射线般增长，就需要通过压缩技术压缩文件，因为AOF是用记录写操作的命令来记录数据的，所以可以通过将多个单次写操作合并未一个mset这样的操作来实现指令的压缩。</p>
<p>压缩的操作是通过阈值来控制的，阈值的设置在.conf文件中。</p>
<p>如果Redis的AOF当前大小&gt;= base_size +base_size*100% (默认)且当前大小&gt;=64mb(默认)的情况下，Redis会对AOF进行重写。</p>
<h4 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h4><ul>
<li>优势</li>
</ul>
<ol>
<li>备份机制更稳健，丢失数据概率更低。</li>
<li>可读的日志文本，通过操作AOF稳健，可以处理误操作。</li>
</ol>
<ul>
<li>劣势</li>
</ul>
<ol>
<li>比起RDB占用更多的磁盘空间。</li>
<li>恢复备份速度要慢。</li>
<li>每次读写都同步的话，有一定的性能压力。</li>
<li>存在个别Bug，造成恢复不能。</li>
</ol>
<h3 id="RDB和AOF"><a href="#RDB和AOF" class="headerlink" title="RDB和AOF"></a>RDB和AOF</h3><p>官方告诉俺们，两个同时启用比较好。</p>
<p>对数据不敏感，一些数据丢不丢都无所谓可以用RDB，性能最好</p>
<p>不建议单独用AOF，会有一些Bug</p>
<p>做纯缓存，不做写磁盘的操作的，两个都别用了，浪费生命</p>
<p>建议只在Slave上持久化RDB文件，而且只要15分钟备份一次就够了</p>
<p>如果使用AOF，好处是在最恶劣情况下也只会丢失不超过两秒数据，启动脚本较简单只load自己的AOF文件就可以了，但是增加IO负担，带来阻塞。</p>
<h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><p>一开始学习redis时，就提到说，redis的出现是解决了服务器访问负担过重，IO和CPU负担的问题，所以需要配备多台服务器，但是多台服务器又有session不同步的问题，虽然可以所有服务器都请求一个redis服务，但是如果这个redis服务宕机了，或是造成了不能发生的写操作，会有灾难性后果。</p>
<p>主从复制是主机数据更新后根据配置和策略，自动同步到备机的master/slaver机制，Master以写为主，Slave以读为主。</p>
<p>实现了</p>
<ul>
<li>读写分离，性能扩展</li>
<li>容灾快速恢复</li>
</ul>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>谁是主谁是从是需要从机 <code>&gt;slaveof 主机ip 端口</code> 标识从机身份，然后就实现了主从的分配，分配后主机中，主机只能写，从机只能读，从机能够完全读到主机的数据，是同步的，主机每次写操作都把数据同步到从机上</p>
<p>当从机抛弃标识后，写服务就停止了，若是主机宕机，从机的标识还在，等到主机重启后，又与主机数据同步，为了解决主机宕机的问题，所以需要将从机标识为主机继续写服务</p>
<ul>
<li>薪火相传</li>
</ul>
<p>这个结构就像是树，根节点就是老祖宗主机，其下的从机又作为其子子孙孙的主机存在，理解可以想想主流和支流，主流的水支流是能喝到的，如果上游的水被污染了，那么下流就会被污染。</p>
<p>一旦双重身份的节点宕机了，那其下的所有支流都没数据</p>
<ul>
<li>反客为主</li>
</ul>
<p>slaveof no one </p>
<p>当薪火相传中双重身份的节点其上的主机宕机了，用以上命令，就变为主机，其下的从机身份不变，只是数据源变为该双重身份的节点，变为主机能写。</p>
<ul>
<li><p>宕机了</p>
<ol>
<li>从机宕机</li>
</ol>
<ul>
<li>等到重新连接上主机在执行同步操作，实行增量操作</li>
</ul>
<ol start="2">
<li>主机宕机</li>
</ol>
<ul>
<li>其中从机凡客为主，暂时提供写操作</li>
<li>等到主机回来了，把原主机设置为从机</li>
</ul>
<ol start="3">
<li>自动化处理—哨兵模式sentinel</li>
</ol>
</li>
<li><p>哨兵模式</p>
</li>
</ul>
<p>mkdir一个文件夹，vi一个sentinel.conf文件，名字不能错，配置哨兵信息</p>
<pre><code>sentinel monitor mymaster 127.0.0.1 6379 1
启动哨兵
redis-sentinel  */sentinel.conf 
</code></pre>
<p>表示哨兵监视外号为mymaster其ip地址为127.0.0.1的6379端口服务，至少有一个哨兵同意迁移</p>
<ol>
<li>有一个主从关系的集群</li>
<li>主机宕机了</li>
<li>哨兵监视到主机宕机了，通过从机选举产生新的主机</li>
</ol>
<ul>
<li>优先级高的</li>
<li>偏移量大的，此偏移量表示和主机的数据相似度最高，<code>slave-priority 100</code> .conf文件中默认的</li>
<li>runid最小的，在redis启动时随机生成</li>
</ul>
<ol start="4">
<li>选举到的从机变为master，拥有写权限，原来的其他从机以此主机作为从机</li>
<li>若是老主机恢复运行，将作为新主机的从机运行</li>
</ol>
<h2 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h2><p>解决有限redis主机容量不够，分摊并发操作的问题，redis提出过两种方案</p>
<ul>
<li>&lt;redis3.0 代理主机 指所有请求统统发送到同一ip地址的代理主机上，再由代理主机调用其他服务redis，实现功能。</li>
<li>代理主机冗余，需要多维护代理主机群，代理宕了所有服务全部停用</li>
<li><blockquote>
<p>redis3.0 去中心化处理，指客户端可以访问到任意redis服务主机，各个主机之间有相互访问的接口，这样的一群主机对内是集群，对外暴露可视为一个redis服务。</p>
</blockquote>
</li>
<li>集群内只有服务，没有冗余服务器主机，某些服务宕机，其他服务在一定条件下仍可以访问</li>
</ul>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><ol>
<li>删除所有的持久化文件</li>
<li>redis.conf配置文件</li>
</ol>
<ul>
<li>daemonize yes</li>
<li>Pid文件名字</li>
<li>指定端口</li>
<li>Log文件名字</li>
<li>Dump.rdb名字</li>
<li>Appendonly 关掉或者换名字</li>
</ul>
<ol start="3">
<li>redis cluster配置修改</li>
</ol>
<ul>
<li>cluster-enabled yes</li>
<li>cluster-config-file 节点配置文件.conf</li>
<li>cluster-node-timeout 15000 节点失联时间 自动主从切换</li>
</ul>
<ol start="4">
<li>根据各自的配置文件启动redis服务，查看节点配置文件都生成正常</li>
<li>cd到redis6.2.1/src下 <code>&gt;redis-cli --cluster create --cluster-replicas 1</code> 将自动配置集群为一主一从的模式，看数字1 其后的所有redis ip主机 前半为master，后半为salve，自动为集群分配插件，每个服务将通过插件进行主机move</li>
</ol>
<ul>
<li>一个Redis集群包含16384个插槽（hash slot），数据库中的每个键都属于这16384个插槽的其中一个，用CRC16计算key的校验和并move</li>
<li>-c 自动重定向，根据计算的key获得插槽，并移动到对此插槽服务的主机上</li>
</ul>
<ol start="6">
<li>通过redis-cli -p port -a password 进入集群中某一个节点，即可访问整个集群</li>
</ol>
<h3 id="故障恢复"><a href="#故障恢复" class="headerlink" title="故障恢复"></a>故障恢复</h3><ul>
<li>主节点下线，和集群实现自动的”哨兵机制” 当哨兵检测到主机宕机后，则根据15秒超时切换主机，等到原主机上线变为从机</li>
<li>某段插槽所有服务都宕机，看<code>cluster-require-full-coverage</code>，是yes时则整个集群都挂掉，为no则该插槽服务停止服务，其他插槽仍正常</li>
</ul>
<h3 id="亿点点细节"><a href="#亿点点细节" class="headerlink" title="亿点点细节"></a>亿点点细节</h3><ul>
<li>集群中的多键操作是不支持的</li>
<li>由于集群中键怎么插入插槽是由CRC16决定的，插入的键值极难在同一组插槽中，而插槽组只能处理本组事务，不能跨插槽处理</li>
<li>以mset key1{组名} value1 key2{组名} value2 …可以实现所有值插在同一个组中</li>
<li>事务不被支持，lua不支持</li>
<li>与多键同理，因为事务中执行的操作基本是跨组的，所以不能实现</li>
</ul>
<h2 id="应用常见BUG"><a href="#应用常见BUG" class="headerlink" title="应用常见BUG"></a>应用常见BUG</h2><p>redis作为中间件在客户端和服务器间主要起到缓解服务器和数据库压力的作用，虽然解决问题，但是因为加了一层，带来了新的问题</p>
<h3 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h3><h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><ul>
<li>引用服务器压力突然变大，高并发的操作</li>
<li>redis查询命中率降低，导致中间件不起作用</li>
<li>命中率低，导致一直查询数据库，压力变大</li>
</ul>
<h4 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h4><ol>
<li>redis查不到数据，一直向数据库请求服务</li>
<li>出现很多非正常的url访问，如访问到ip/prot了，但是没有url指向的api</li>
<li>黑客恶意攻击</li>
</ol>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><ul>
<li>空值缓存，让redis将查不到的数据 set key null，返回给客户空值</li>
<li>设置白名单，用bitmaps，对应可访问的id，放行访问</li>
<li>布隆过滤器，极优的T(O)和S(O)，快速检索元素是否在一个集合中，缺点是一定的误识别率和删除困难</li>
<li>实时监控，人工监控恶意访问并放入黑名单</li>
</ul>
<h3 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h3><h4 id="场景-1"><a href="#场景-1" class="headerlink" title="场景"></a>场景</h4><ul>
<li>DB访问压力瞬间upup</li>
<li>redis某key突然过期</li>
<li>redis正常</li>
</ul>
<h4 id="原因-1"><a href="#原因-1" class="headerlink" title="原因"></a>原因</h4><ul>
<li>redis过期的某key突然被大量访问，查不到，所以向数据库请求高并发查询</li>
</ul>
<h4 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h4><ol>
<li>把key做预热，将可能高峰访问的key过期时间延长</li>
<li>即使调整，查到某热点问题，将该key过期时间延长</li>
<li>使用锁</li>
</ol>
<ul>
<li>把查询上锁，若是查询到有锁，则不进行查询操作，睡眠一段时间后再次查询</li>
</ul>
<h3 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h3><h4 id="场景-2"><a href="#场景-2" class="headerlink" title="场景"></a>场景</h4><ul>
<li>DB压力变大，服务器崩溃</li>
</ul>
<h4 id="原因-2"><a href="#原因-2" class="headerlink" title="原因"></a>原因</h4><ul>
<li>在极短的时间内，大量的key过期但是被查询</li>
</ul>
<h4 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h4><ol>
<li>构建多级缓存架构</li>
</ol>
<ul>
<li>nginx缓存 + redis缓存 +其他缓存（ehcache等）</li>
<li>多级缓存是并列的</li>
</ul>
<ol start="2">
<li>锁或队列 不适合高并发情景</li>
<li>设置过期标识更新缓存 触警即后台更新缓存</li>
<li>将缓存失效时间分散，即设置随机的过期时间，降低同时大量key失效的情况</li>
</ol>
<h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><p>产生分布式锁的原因的原因，是因为分布式集群系统中并不是某一个主机的<strong>多线程多进程</strong>，而是分布在集群上的多线程多进程。</p>
<p>所以需要分布锁，跨JVM的互斥机制来控制共享资源的访问</p>
<ul>
<li>分布式锁主流的实现方案：</li>
</ul>
<ol>
<li>基于数据库实现分布式锁</li>
<li>基于缓存（Redis等）</li>
<li>基于Zookeeper</li>
</ol>
<ul>
<li>每一种分布式锁解决方案都有各自的优缺点：</li>
</ul>
<ol>
<li><p>性能：redis最高</p>
</li>
<li><p>可靠性：zookeeper最高</p>
<h4 id="redis分布锁"><a href="#redis分布锁" class="headerlink" title="redis分布锁"></a>redis分布锁</h4><p>我认为使用redis实现分布锁主要利用redis的单线程的实质，将服务放在单线程中就自然实现了锁的功能</p>
</li>
<li><p>加锁：执行setnx，若成功再执行expire添加过期时间</p>
</li>
<li><p>解锁：执行delete命令</p>
</li>
</ol>
<p>高并发场景中，key没上锁，那setnx就能执行，执行完之后释放锁，期间其他未能取到锁的操作则等待锁释放。</p>
<ul>
<li>当操作1正要del时，由于超时时间已过，操作2取得了锁，此时操作1del的就是操作2刚取得的锁。</li>
<li>当setnx取得锁时，先设置一个唯一的uuid，释放前判断是不是这个值，不是自己的锁不能del，这个行为比较像乐观锁，CAS操作。</li>
<li>为了增加鲁棒性，减少cli误删锁和持有过期锁，使用lua脚本完成键值删除的操作</li>
<li>此时不再用del来释放锁，使用随机token作为key，当lua脚本检测到cli发送的值和key相同时才用lua释放锁</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E8%BF%9E%E6%8E%A5/" rel="tag"># 连接</a>
              <a href="/tags/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" rel="tag"># 数据类型</a>
              <a href="/tags/%E4%BA%8B%E5%8A%A1/" rel="tag"># 事务</a>
              <a href="/tags/%E6%8C%81%E4%B9%85%E5%8C%96/" rel="tag"># 持久化</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/07/29/%E4%BA%8B%E5%8A%A1/" rel="prev" title="事务">
                  <i class="fa fa-chevron-left"></i> 事务
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/08/30/%E5%9B%BE%E5%BA%8A/" rel="next" title="图床">
                  图床 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Virogoniagee</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
